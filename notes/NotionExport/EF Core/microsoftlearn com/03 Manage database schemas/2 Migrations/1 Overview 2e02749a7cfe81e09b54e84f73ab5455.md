# 1. Overview

# Migrations Overview

**Migrations** allow you to incrementally update your database schema as your application's data model changes. They preserve existing data while evolving the database structure to match your C# code.

## 1. High-Level Workflow

- **Modify the Model:** You add, remove, or change properties/entities in your `DbContext`.
- **Add a Migration:** EF Core compares your current code to a **snapshot** of the previous model and generates a new migration file.
- **Apply the Migration:** You update the database manually during development or automatically during deployment. EF Core tracks applied migrations in a `__EFMigrationsHistory` table.

## 2. Tooling Commands

| Task | .NET CLI (`dotnet ef`) | Package Manager Console (VS) |
| --- | --- | --- |
| **Add Migration** | `dotnet ef migrations add <Name>` | `Add-Migration <Name>` |
| **Update Database** | `dotnet ef database update` | `Update-Database` |
| **Remove Migration** | `dotnet ef migrations remove` | `Remove-Migration` |
| **Script SQL** | `dotnet ef migrations script` | `Script-Migration` |

## 3. Key Concepts

### Model Snapshot

When you add a migration, EF Core creates or updates a `ModelSnapshot.cs` file. This is a code-based representation of your entire model. EF Core uses it to calculate the difference (delta) when you create the *next* migration.

### Migration Files

A migration consists of two parts:

- **Up:** Code to apply the changes to the database.
- **Down:** Code to revert the changes.

### History Table

By default, EF Core creates a table named `__EFMigrationsHistory` in your database. It stores the names of all migrations that have been successfully applied to prevent re-applying the same changes.

## 4. Advanced: Excluding Parts of the Model

If you have multiple `DbContext` types sharing the same database, you may want to prevent one context from trying to manage a table owned by another.

```csharp
protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    modelBuilder.Entity<IdentityUser>()
        .ToTable("AspNetUsers", t => t.ExcludeFromMigrations());
}

```

## 5. Summary Tips

- **Naming:** Use descriptive names like `AddUserEmail` or `RenameProductToItem`.
- **Review:** Always review the generated migration code before applying it to catch unintended changes.
- **Source Control:** Migration files and the model snapshot **must** be checked into your version control system (e.g., Git).