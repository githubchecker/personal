# 2. One-to-many

# One-to-Many Relationships

A **One-to-Many** relationship occurs when a single principal entity is associated with multiple dependent entities (e.g., a `Blog` has many `Posts`).

## 1. Required vs. Optional Relationships

### Required One-to-Many

Every dependent must be linked to a principal.

- **Convention:** Use a non-nullable Foreign Key (e.g., `int BlogId`).
- **NRT:** `Blog Blog { get; set; } = null!;`

```csharp
modelBuilder.Entity<Blog>()
    .HasMany(b => b.Posts)
    .WithOne(p => p.Blog)
    .HasForeignKey(p => p.BlogId)
    .IsRequired();

```

### Optional One-to-Many

Dependents can exist without a principal.

- **Convention:** Use a nullable Foreign Key (e.g., `int? BlogId`).
- **NRT:** `Blog? Blog { get; set; }`

```csharp
modelBuilder.Entity<Blog>()
    .HasMany(b => b.Posts)
    .WithOne(p => p.Blog)
    .HasForeignKey(p => p.BlogId)
    .IsRequired(false);

```

## 2. Navigations and Shadow Keys

### Navigations

- **Bidirectional:** Navigations exist on both ends (`Blog.Posts` and `Post.Blog`).
- **Unidirectional:** Navigation exists on only one end. Use `WithOne()` or `WithMany()` without arguments to indicate missing navigations.

### Shadow Foreign Keys

If you omit the FK property from the class, EF Core creates a **Shadow FK** in the background.

```csharp
modelBuilder.Entity<Blog>()
    .HasMany(b => b.Posts)
    .WithOne(p => p.Blog)
    .HasForeignKey("BlogId"); // String name for shadow property

```

## 3. Advanced Configuration

### Using Alternate Keys (`HasPrincipalKey`)

Reference a unique property other than the Primary Key:

```csharp
builder.HasMany(b => b.Posts)
    .WithOne(p => p.Blog)
    .HasPrincipalKey(b => b.AlternateId);

```

### Composite Foreign Keys

If the principal has a composite key, the dependent must have matching FK properties:

```csharp
builder.Entity<Blog>().HasKey(b => new { b.Key1, b.Key2 });

builder.Entity<Post>()
    .HasOne(p => p.Blog)
    .WithMany(b => b.Posts)
    .HasForeignKey(p => new { p.BlogKey1, p.BlogKey2 });

```

### Self-Referencing Relationships

Entities that relate to themselves (e.g., Managers and Employees):

```csharp
public class Employee
{
    public int Id { get; set; }
    public int? ManagerId { get; set; }
    public Employee? Manager { get; set; }
    public ICollection<Employee> Reports { get; } = new List<Employee>();
}

modelBuilder.Entity<Employee>()
    .HasOne(e => e.Manager)
    .WithMany(e => e.Reports)
    .HasForeignKey(e => e.ManagerId);

```

## 4. Delete Behavior

By default, required relationships use **Cascade Delete** (deleting the principal deletes all dependents). You can override this:

```csharp
builder.HasMany(b => b.Posts)
    .WithOne(p => p.Blog)
    .OnDelete(DeleteBehavior.Restrict); // Prevent deletion if dependents exist

```