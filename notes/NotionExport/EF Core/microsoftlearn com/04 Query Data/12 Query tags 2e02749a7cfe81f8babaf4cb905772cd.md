# 12. Query tags

# Query Tags

**Query Tags** allow you to add custom comments to the SQL generated by EF Core. This is an invaluable tool for profiling, debugging, and correlating slow database queries back to specific LINQ code in your application.

## 1. Using `TagWith()`

You can annotate any LINQ query using the `TagWith()` extension method.

```csharp
var myLocation = new Point(1, 2);
var nearestPeople = await context.People
    .TagWith("Spatial Query: Finding nearest people") // Tag added here
    .OrderBy(p => p.Location.Distance(myLocation))
    .Take(5)
    .ToListAsync();

```

### Generated SQL Output

The tag appears as a SQL comment at the top of the command:

```sql
-- Spatial Query: Finding nearest people

SELECT TOP(5) [p].[Id], [p].[Location]
FROM [People] AS [p]
ORDER BY [p].[Location].STDistance(@__myLocation_0)

```

## 2. Cumulative Tags

If a query is built across multiple methods, each `TagWith()` call adds a new line to the SQL comments.

```csharp
public IQueryable<Post> GetPublishedPosts(BloggingContext db)
    => db.Posts.TagWith("Source: GetPublishedPosts").Where(p => p.IsPublished);

public IQueryable<Post> ApplyLimit(IQueryable<Post> query)
    => query.TagWith("Logic: Applying row limit").Take(10);

// Final call
var results = await ApplyLimit(GetPublishedPosts(context)).ToListAsync();

```

**SQL Comment Result:**

```sql
-- Source: GetPublishedPosts
-- Logic: Applying row limit

SELECT ...

```

## 3. Multi-line Tags

You can use C# verbatim strings to create multi-line SQL comments.

```csharp
var query = context.Blogs.TagWith(@"
    Author: Arpan
    Task: ID-1024
    Purpose: Audit Log Export");

```

## 4. Key Takeaways and Limitations

- **Debugging:** Tags make it easy to find where a query originated when using database profiling tools (like SQL Server Profiler or Azure Query Performance Insight).
- **Literals Only:** Query tags must be string literals. They **cannot** be parameterized (you cannot pass a variable that changes at runtime to `TagWith` if using compiled queries).
- **Performance:** There is zero performance impact on the database execution, as comments are ignored by the SQL engine.