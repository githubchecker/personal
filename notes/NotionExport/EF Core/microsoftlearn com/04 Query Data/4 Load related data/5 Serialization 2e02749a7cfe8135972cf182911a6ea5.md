# 5. Serialization

# Related Data and Serialization

In EF Core, navigation fix-up creates circular references (e.g., `Blog` -> `Post` -> `Blog`). Standard JSON serializers will crash with a "circular reference" error when trying to serialize these object graphs.

## 1. Global Serializer Configuration

You can configure your application to ignore or handle cycles during serialization.

### System.Text.Json (Default in .NET Core)

In your `Program.cs` or `Startup.cs`:

```csharp
services.AddControllers().AddJsonOptions(options =>
{
    options.JsonSerializerOptions.ReferenceHandler = ReferenceHandler.IgnoreCycles;
});

```

### Newtonsoft.Json (Json.NET)

```csharp
services.AddControllers().AddNewtonsoftJson(options =>
{
    options.SerializerSettings.ReferenceLoopHandling = ReferenceLoopHandling.Ignore;
});

```

## 2. Using the `[JsonIgnore]` Attribute

If you only want to stop serialization on specific properties, use the `[JsonIgnore]` attribute. This prevents the serializer from following the navigation property back to the parent.

```csharp
public class Post
{
    public int Id { get; set; }
    
    [JsonIgnore] // Serialization stops here
    public virtual Blog Blog { get; set; }
}

```

## 3. Best Practice: Use DTOs

Instead of serializing raw database entities, project your data into **DTOs (Data Transfer Objects)**. This allows you to control exactly what data is sent to the client and avoids circular reference issues entirely.

```csharp
var blogData = await context.Blogs
    .Select(b => new BlogDto {
        Id = b.Id,
        Title = b.Title,
        PostTitles = b.Posts.Select(p => p.Title).ToList() // No circular reference
    })
    .ToListAsync();

```

## 4. Summary

| Approach | Pros | Cons |
| --- | --- | --- |
| **Ignore Cycles** | Quick global fix. | May hide structural issues in model. |
| `[JsonIgnore]` | Explicit control per property. | Hardcoded; affects all serialization contexts. |
| **DTOs (Recommended)** | Decouples DB from API; best performance. | Requires extra classes/mapping code. |