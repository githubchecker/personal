# 23. DatabaseGenerated Attribute in Entity Framework Core

# DatabaseGenerated Attribute in Entity Framework Core

The `[DatabaseGenerated]` attribute in Entity Framework Core (EF Core) specifies how a propertyâ€™s value is generated by the database. It informs EF Core whether the database should handle value creation during insertion or updates, or if the application is responsible for providing the value.

This attribute is part of the `System.ComponentModel.DataAnnotations.Schema` namespace.

---

### DatabaseGeneratedOption Enum

The attribute requires one of the three options from the `DatabaseGeneratedOption` enum:

1. **None**: The database does not generate a value; the application must provide it.
2. **Identity**: The database generates a value when a new row is inserted. This is commonly used for auto-incrementing primary keys.
3. **Computed**: The database generates or updates a value on every insert and update. This is often used for calculated columns or last-modified timestamps.

---

### 1. DatabaseGeneratedOption.None

Use this option to prevent the database from automatically generating a value for a property. This is useful when you want to provide your own primary key values, such as GUIDs generated by the application or IDs coming from an external system.

### Example: Application-Generated GUIDs

```csharp
using System;
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

public class Product
{
    [Key]
    [DatabaseGenerated(DatabaseGeneratedOption.None)]
    public Guid ProductId { get; set; } // Application must assign a value

    public string Name { get; set; }
}
```

---

### 2. DatabaseGeneratedOption.Identity

The `Identity` option tells EF Core that the database will provide a unique sequential value when a record is first inserted. While EF Core automatically treats `int` primary keys as identity columns by default, you can use this attribute for non-primary key columns or to be explicit.

### Example: Sequential Serial Numbers

```csharp
public class Product
{
    public int ProductId { get; set; } // PK

    [DatabaseGenerated(DatabaseGeneratedOption.Identity)]
    public int internalId { get; set; } // Non-PK identity column

    public string SKU { get; set; }
}
```

---

### 3. DatabaseGeneratedOption.Computed

Use the `Computed` option for properties whose values are calculated by the database based on other columns. These properties are typically read-only in the application, and their values are refreshed from the database after every insert or update.

### Example: Calculated Columns

```csharp
public class OrderItem
{
    public int OrderItemId { get; set; }
    public decimal Price { get; set; }
    public int Quantity { get; set; }

    [DatabaseGenerated(DatabaseGeneratedOption.Computed)]
    public decimal TotalPrice { get; set; } // Price * Quantity
}
```

*Note: To actually implement the calculation in the database, you must also configure the SQL formula in the `DbContext` using the Fluent API.*

---

### Fluent API Alternatives

The same configurations can be applied using the Fluent API in the `OnModelCreating` method:

```csharp
protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    // Equivalent to DatabaseGeneratedOption.None
    modelBuilder.Entity<Product>()
        .Property(p => p.ProductId)
        .ValueGeneratedNever();

    // Equivalent to DatabaseGeneratedOption.Identity
    modelBuilder.Entity<Product>()
        .Property(p => p.internalId)
        .ValueGeneratedOnAdd();

    // Equivalent to DatabaseGeneratedOption.Computed
    modelBuilder.Entity<OrderItem>()
        .Property(oi => oi.TotalPrice)
        .HasComputedColumnSql("[Quantity] * [Price]");
    
    modelBuilder.Entity<OrderItem>.Property(e => e.CreatedAt)
          .HasDefaultValueSql("GETDATE()") // SQL Server function to insert current timestamp
          .ValueGeneratedOnAdd();

    modelBuilder.Entity<OrderItem>.Property(e => e.UpdatedAt)
        .HasDefaultValueSql("GETDATE()") // Initial default value
        .ValueGeneratedOnAddOrUpdate()
}
```

---

### Summary of Behavior

| Option | Timing | Use Case |
| --- | --- | --- |
| **None** | Never | For primary keys where the app provides the ID (e.g., GUIDs, External IDs). |
| **Identity** | On Insert | For auto-incrementing integers or serial numbers. |
| **Computed** | On Insert & Update | For calculated fields, full names, or automatic timestamps. |

### When to Use

- **Data Integrity**: Use `Computed` to ensure calculations are performed once at the database level to maintain consistency.
- **Performance**: `Identity` handles unique ID generation efficiently at the database level, reducing application overhead.
- **External Integration**: Use `None` when your primary keys are determined by another service or must follow specific non-sequential logic.