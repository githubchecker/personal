# Request decompression in ASP.NET Core

By [David Acker](https://github.com/david-acker)

Request decompression middleware:

* Enables API endpoints to accept requests with compressed content.
* Uses the [ `Content-Encoding` ](https://developer.mozilla.org/docs/Web/HTTP/Headers/Content-Encoding) HTTP header to automatically identify and decompress requests which contain compressed content.
* Eliminates the need to write code to handle compressed requests.

When the  `Content-Encoding`  header value on a request matches one of the available decompression providers, the middleware:

* Uses the matching provider to wrap the [HttpRequest.Body](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.httprequest.body#microsoft-aspnetcore-http-httprequest-body) in an appropriate decompression stream.
* Removes the  `Content-Encoding`  header, indicating that the request body is no longer compressed.

Requests that don't include a  `Content-Encoding`  header are ignored by the request decompression middleware.

Decompression:

* Occurs when the body of the request is read. That is, decompression occurs at the endpoint on model binding. The request body isn't decompressed eagerly.
* When attempting to read the decompressed request body with invalid compressed data for the specified  `Content-Encoding` , an exception is thrown. Brotli can throw [System.InvalidOperationException](https://learn.microsoft.com/en-us/dotnet/api/system.invalidoperationexception): Decoder ran into invalid data. Deflate and GZip can throw [System.IO.InvalidDataException](https://learn.microsoft.com/en-us/dotnet/api/system.io.invaliddataexception): The archive entry was compressed using an unsupported compression method.

If the middleware encounters a request with compressed content but is unable to decompress it, the request is passed to the next delegate in the pipeline. For example, a request with an unsupported  `Content-Encoding`  header value or multiple  `Content-Encoding`  header values is passed to the next delegate in the pipeline.

## Configuration

The following code uses [AddRequestDecompression(IServiceCollection)](https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.requestdecompressionserviceextensions.addrequestdecompression#microsoft-extensions-dependencyinjection-requestdecompressionserviceextensions-addrequestdecompression(microsoft-extensions-dependencyinjection-iservicecollection)) and [UseRequestDecompression](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.requestdecompressionbuilderextensions.userequestdecompression) to enable request decompression for the [default](https://learn.microsoft.com/en-us/aspnet/core/#default)  `Content-Encoding`  types:

```csharp
var builder = WebApplication.CreateBuilder(args);

builder.Services.AddRequestDecompression();

var app = builder.Build();

app.UseRequestDecompression();

app.MapPost("/", (HttpRequest request) => Results.Stream(request.Body));

app.Run();
```

## Default decompression providers

The  `Content-Encoding`  header values that the request decompression middleware supports by default are listed in the following table:

| [ `Content-Encoding` ](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Encoding) header values | Description |
| --- | --- |
| `br` | [Brotli compressed data format](https://tools.ietf.org/html/rfc7932) |
| `deflate` | [DEFLATE compressed data format](https://tools.ietf.org/html/rfc1951) |
| `gzip` | [Gzip file format](https://tools.ietf.org/html/rfc1952) |

## Custom decompression providers

Support for custom encodings can be added by creating custom decompression provider classes that implement [IDecompressionProvider](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.requestdecompression.idecompressionprovider):

```csharp
public class CustomDecompressionProvider : IDecompressionProvider
{
    public Stream GetDecompressionStream(Stream stream)
    {
        // Perform custom decompression logic here
        return stream;
    }
}
```

Custom decompression providers are registered with [RequestDecompressionOptions](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.requestdecompression.requestdecompressionoptions) along with their corresponding  `Content-Encoding`  header values:

```csharp
var builder = WebApplication.CreateBuilder(args);

builder.Services.AddRequestDecompression(options =>
{
    options.DecompressionProviders.Add("custom", new CustomDecompressionProvider());
});

var app = builder.Build();

app.UseRequestDecompression();

app.MapPost("/", (HttpRequest request) => Results.Stream(request.Body));

app.Run();
```

## Request size limits

In order to protect against [zip bombs or decompression bombs](https://en.wikipedia.org/wiki/Zip_bomb):

* The maximum size of the decompressed request body is limited to the request body size limit enforced by the endpoint or server.
* If the number of bytes read from the decompressed request body stream exceeds the limit, an [InvalidOperationException](https://learn.microsoft.com/en-us/dotnet/api/system.invalidoperationexception) is thrown to prevent additional bytes from being read from the stream.

In order of precedence, the maximum request size for an endpoint is set by:

1. [IRequestSizeLimitMetadata.MaxRequestBodySize](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.metadata.irequestsizelimitmetadata.maxrequestbodysize#microsoft-aspnetcore-http-metadata-irequestsizelimitmetadata-maxrequestbodysize), such as [RequestSizeLimitAttribute](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.requestsizelimitattribute) or [DisableRequestSizeLimitAttribute](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.disablerequestsizelimitattribute) for MVC endpoints.
2. The global server size limit [IHttpMaxRequestBodySizeFeature.MaxRequestBodySize](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.features.ihttpmaxrequestbodysizefeature.maxrequestbodysize#microsoft-aspnetcore-http-features-ihttpmaxrequestbodysizefeature-maxrequestbodysize).  `MaxRequestBodySize`  can be overridden per request with [IHttpMaxRequestBodySizeFeature.MaxRequestBodySize](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.features.ihttpmaxrequestbodysizefeature.maxrequestbodysize#microsoft-aspnetcore-http-features-ihttpmaxrequestbodysizefeature-maxrequestbodysize), but defaults to the limit configured for the web server implementation.

| Web server implementation | `MaxRequestBodySize`  configuration |
| --- | --- |
| [HTTP.sys](https://learn.microsoft.com/en-us/aspnet/servers/httpsys?view=aspnetcore-10.0) | [HttpSysOptions.MaxRequestBodySize](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.server.httpsys.httpsysoptions.maxrequestbodysize#microsoft-aspnetcore-server-httpsys-httpsysoptions-maxrequestbodysize) |
| [IIS](https://learn.microsoft.com/en-us/host-and-deploy/iis/?view=aspnetcore-10.0) | [IISServerOptions.MaxRequestBodySize](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.iisserveroptions.maxrequestbodysize#microsoft-aspnetcore-builder-iisserveroptions-maxrequestbodysize) |
| [Kestrel](https://learn.microsoft.com/en-us/aspnet/servers/kestrel?view=aspnetcore-10.0) | [KestrelServerLimits.MaxRequestBodySize](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.server.kestrel.core.kestrelserverlimits.maxrequestbodysize#microsoft-aspnetcore-server-kestrel-core-kestrelserverlimits-maxrequestbodysize) |

> [!WARNING]
> Disabling the request body size limit poses a security risk in regards to uncontrolled resource consumption, particularly if the request body is being buffered. Ensure that safeguards are in place to mitigate the risk of [denial-of-service](https://www.cisa.gov/uscert/ncas/tips/ST04-015) (DoS) attacks.

## Additional Resources

* [ASP.NET Core Middleware](https://learn.microsoft.com/en-us/aspnet/core/?view=aspnetcore-10.0)
* [Mozilla Developer Network: Content-Encoding](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Encoding)
* [Brotli Compressed Data Format](https://www.rfc-editor.org/rfc/rfc7932)
* [DEFLATE Compressed Data Format Specification version 1.3](https://www.rfc-editor.org/rfc/rfc1951)
* [GZIP file format specification version 4.3](https://www.rfc-editor.org/rfc/rfc1952)