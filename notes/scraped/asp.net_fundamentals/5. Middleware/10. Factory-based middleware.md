# Factory-based middleware activation in ASP.NET Core

[IMiddlewareFactory](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.imiddlewarefactory)/[IMiddleware](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.imiddleware) is an extensibility point for [middleware](https://learn.microsoft.com/en-us/aspnet/core/?view=aspnetcore-10.0) activation that offers the following benefits:

* Activation per client request (injection of scoped services)
* Strong typing of middleware

[UseMiddleware](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.usemiddlewareextensions.usemiddleware) extension methods check if a middleware's registered type implements [IMiddleware](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.imiddleware). If it does, the [IMiddlewareFactory](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.imiddlewarefactory) instance registered in the container is used to resolve the [IMiddleware](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.imiddleware) implementation instead of using the convention-based middleware activation logic. The middleware is registered as a [scoped or transient service](https://learn.microsoft.com/en-us/aspnet/dependency-injection?view=aspnetcore-10.0#service-lifetimes) in the app's service container.

[IMiddleware](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.imiddleware) is activated per client request (connection), so scoped services can be injected into the middleware's constructor.

## IMiddleware

[IMiddleware](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.imiddleware) defines middleware for the app's request pipeline. The [InvokeAsync(HttpContext, RequestDelegate)](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.imiddleware.invokeasync) method handles requests and returns a [Task](https://learn.microsoft.com/en-us/dotnet/api/system.threading.tasks.task) that represents the execution of the middleware.

Middleware activated by convention:

```csharp
public class ConventionalMiddleware
{
    private readonly RequestDelegate _next;

    public ConventionalMiddleware(RequestDelegate next)
        => _next = next;

    public async Task InvokeAsync(HttpContext context, SampleDbContext dbContext)
    {
        var keyValue = context.Request.Query["key"];

        if (!string.IsNullOrWhiteSpace(keyValue))
        {
            dbContext.Requests.Add(new Request("Conventional", keyValue));

            await dbContext.SaveChangesAsync();
        }

        await _next(context);
    }
}
```

Middleware activated by [MiddlewareFactory](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.middlewarefactory):

```csharp
public class FactoryActivatedMiddleware : IMiddleware
{
    private readonly SampleDbContext _dbContext;

    public FactoryActivatedMiddleware(SampleDbContext dbContext)
        => _dbContext = dbContext;

    public async Task InvokeAsync(HttpContext context, RequestDelegate next)
    {
        var keyValue = context.Request.Query["key"];

        if (!string.IsNullOrWhiteSpace(keyValue))
        {
            _dbContext.Requests.Add(new Request("Factory", keyValue));

            await _dbContext.SaveChangesAsync();
        }

        await next(context);
    }
}
```

Extensions are created for the middleware:

```csharp
public static class MiddlewareExtensions
{
    public static IApplicationBuilder UseConventionalMiddleware(
        this IApplicationBuilder app)
        => app.UseMiddleware<ConventionalMiddleware>();

    public static IApplicationBuilder UseFactoryActivatedMiddleware(
        this IApplicationBuilder app)
        => app.UseMiddleware<FactoryActivatedMiddleware>();
}
```

It isn't possible to pass objects to the factory-activated middleware with [UseMiddleware](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.usemiddlewareextensions.usemiddleware):

```csharp
public static IApplicationBuilder UseFactoryActivatedMiddleware(
    this IApplicationBuilder app, bool option)
{
    // Passing 'option' as an argument throws a NotSupportedException at runtime.
    return app.UseMiddleware<FactoryActivatedMiddleware>(option);
}
```

The factory-activated middleware is added to the built-in container in  `Program.cs` :

```csharp
var builder = WebApplication.CreateBuilder(args);

builder.Services.AddDbContext<SampleDbContext>
    (options => options.UseInMemoryDatabase("SampleDb"));

builder.Services.AddTransient<FactoryActivatedMiddleware>();
```

Both middleware are registered in the request processing pipeline, also in  `Program.cs` :

```csharp
var app = builder.Build();

app.UseConventionalMiddleware();
app.UseFactoryActivatedMiddleware();
```

## IMiddlewareFactory

[IMiddlewareFactory](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.imiddlewarefactory) provides methods to create middleware. The middleware factory implementation is registered in the container as a scoped service.

The default [IMiddlewareFactory](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.imiddlewarefactory) implementation, [MiddlewareFactory](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.middlewarefactory), is found in the [Microsoft.AspNetCore.Http](https://www.nuget.org/packages/Microsoft.AspNetCore.Http/) package.