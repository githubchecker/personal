# Middleware in Minimal API apps

[ `WebApplication` ](https://learn.microsoft.com/en-us/aspnet/core/webapplication?view=aspnetcore-10.0) automatically adds the following middleware in [Minimal API applications](https://learn.microsoft.com/en-us/aspnet/apis?view=aspnetcore-10.0) depending on certain conditions:

* [ `UseDeveloperExceptionPage` ](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.diagnostics.developerexceptionpagemiddleware) is added first when the [ `HostingEnvironment` ](https://learn.microsoft.com/en-us/aspnet/environments?view=aspnetcore-10.0) is  `"Development"` .
* [ `UseRouting` ](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.endpointroutingapplicationbuilderextensions.userouting) is added second if user code didn't already call  `UseRouting`  and if there are endpoints configured, for example  `app.MapGet` .
* [ `UseEndpoints` ](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.endpointroutingapplicationbuilderextensions.useendpoints) is added at the end of the middleware pipeline if any endpoints are configured.
* [ `UseAuthentication` ](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.authappbuilderextensions.useauthentication) is added immediately after  `UseRouting`  if user code didn't already call  `UseAuthentication`  and if [ `IAuthenticationSchemeProvider` ](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.authentication.iauthenticationschemeprovider) can be detected in the service provider.  `IAuthenticationSchemeProvider`  is added by default when using [ `AddAuthentication` ](https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.authenticationservicecollectionextensions.addauthentication), and services are detected using [ `IServiceProviderIsService` ](https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.iserviceproviderisservice).
* [ `UseAuthorization` ](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.authorizationappbuilderextensions.useauthorization) is added next if user code didn't already call  `UseAuthorization`  and if [ `IAuthorizationHandlerProvider` ](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.authorization.iauthorizationhandlerprovider) can be detected in the service provider.  `IAuthorizationHandlerProvider`  is added by default when using [ `AddAuthorization` ](https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.authenticationservicecollectionextensions.addauthentication), and services are detected using  `IServiceProviderIsService` .
* User configured middleware and endpoints are added between  `UseRouting`  and  `UseEndpoints` .

The following code is effectively what the automatic middleware being added to the app produces:

```csharp
if (isDevelopment)
{
    app.UseDeveloperExceptionPage();
}

app.UseRouting();

if (isAuthenticationConfigured)
{
    app.UseAuthentication();
}

if (isAuthorizationConfigured)
{
    app.UseAuthorization();
}

// user middleware/endpoints
app.CustomMiddleware(...);
app.MapGet("/", () => "hello world");
// end user middleware/endpoints

app.UseEndpoints(e => {});
```

In some cases, the default middleware configuration isn't correct for the app and requires modification. For example, [UseCors](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.corsmiddlewareextensions.usecors) should be called before [UseAuthentication](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.authappbuilderextensions.useauthentication) and [UseAuthorization](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.authorizationappbuilderextensions.useauthorization). The app needs to call  `UseAuthentication`  and  `UseAuthorization`  if  `UseCors`  is called:

```csharp
app.UseCors();
app.UseAuthentication();
app.UseAuthorization();
```

If middleware should be run before route matching occurs, [UseRouting](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.endpointroutingapplicationbuilderextensions.userouting) should be called and the middleware should be placed before the call to  `UseRouting` . [UseEndpoints](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.endpointroutingapplicationbuilderextensions.useendpoints) isn't required in this case as it is automatically added as described previously:

```csharp
app.Use((context, next) =>
{
    return next(context);
});

app.UseRouting();

// other middleware and endpoints
```

When adding a terminal middleware:

* The middleware must be added after  `UseEndpoints` .
* The app needs to call  `UseRouting`  and  `UseEndpoints`  so that the terminal middleware can be placed at the correct location.

```csharp
app.UseRouting();

app.MapGet("/", () => "hello world");

app.UseEndpoints(e => {});

app.Run(context =>
{
    context.Response.StatusCode = 404;
    return Task.CompletedTask;
});
```

Terminal middleware is middleware that runs if no endpoint handles the request.

For information on antiforgery middleware in Minimal APIs, see [Prevent Cross-Site Request Forgery (XSRF/CSRF) attacks in ASP.NET Core](https://learn.microsoft.com/en-us/security/anti-request-forgery?view=aspnetcore-10.0#afwma)

For more information about middleware see [ASP.NET Core Middleware](https://learn.microsoft.com/en-us/aspnet/middleware/?view=aspnetcore-10.0), and the [list of built-in middleware](https://learn.microsoft.com/en-us/aspnet/middleware/?view=aspnetcore-10.0#built-in-middleware) that can be added to applications.

For more information about Minimal APIs see [APIs overview](https://learn.microsoft.com/en-us/aspnet/apis?view=aspnetcore-10.0).