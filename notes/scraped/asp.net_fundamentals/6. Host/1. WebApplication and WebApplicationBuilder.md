# WebApplication and WebApplicationBuilder in Minimal API apps

## `WebApplication`

The following code is generated by an ASP.NET Core template:

```csharp
var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.MapGet("/", () => "Hello World!");

app.Run();
```

The preceding code can be created via  `dotnet new web`  on the command line or selecting the Empty Web template in Visual Studio.

The following code creates a [WebApplication](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.webapplication) ( `app` ) without explicitly creating a [WebApplicationBuilder](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.webapplicationbuilder):

```csharp
var app = WebApplication.Create(args);

app.MapGet("/", () => "Hello World!");

app.Run();
```

[ `WebApplication.Create` ](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.webapplication.create) initializes a new instance of the [WebApplication](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.webapplication) class with preconfigured defaults.

### Working with ports

When a web app is created with Visual Studio or  `dotnet new` , a  `Properties/launchSettings.json`  file is created that specifies the ports the app responds to. In the port setting samples that follow, running the app from Visual Studio returns an error dialog  `Unable to connect to web server 'AppName'` . Visual Studio returns an error because it's expecting the port specified in  `Properties/launchSettings.json` , but the app is using the port specified by  `app.Run("http://localhost:3000")` . Run the following port changing samples from the command line.

The following sections set the port the app responds to.

```csharp
var app = WebApplication.Create(args);

app.MapGet("/", () => "Hello World!");

app.Run("http://localhost:3000");
```

In the preceding code, the app responds to port  `3000` .

#### Multiple ports

In the following code, the app responds to port  `3000`  and  `4000` .

```csharp
var app = WebApplication.Create(args);

app.Urls.Add("http://localhost:3000");
app.Urls.Add("http://localhost:4000");

app.MapGet("/", () => "Hello World");

app.Run();
```

#### Set the port from the command line

The following command makes the app respond to port  `7777` :

```dotnetcli
dotnet run --urls="https://localhost:7777"
```

If the Kestrel endpoint is also configured in the  `appsettings.json`  file, the  `appsettings.json`  file specified URL is used. For more information, see [Kestrel endpoint configuration](https://learn.microsoft.com/en-us/aspnet/configuration/?view=aspnetcore-10.0#kestrel)

#### Read the port from environment

The following code reads the port from the environment:

```csharp
var app = WebApplication.Create(args);

var port = Environment.GetEnvironmentVariable("PORT") ?? "3000";

app.MapGet("/", () => "Hello World");

app.Run($"http://localhost:{port}");
```

The preferred way to set the port from the environment is to use the  `ASPNETCORE_URLS`  environment variable, which is shown in the following section.

#### Set the ports via the ASPNETCORE\_URLS environment variable

The  `ASPNETCORE_URLS`  environment variable is available to set the port:

```
ASPNETCORE_URLS=http://localhost:3000
```

`ASPNETCORE_URLS`  supports multiple URLs:

```
ASPNETCORE_URLS=http://localhost:3000;https://localhost:5000
```

### Listen on all interfaces

The following samples demonstrate listening on all interfaces

#### http://\*:3000

```csharp
var app = WebApplication.Create(args);

app.Urls.Add("http://*:3000");

app.MapGet("/", () => "Hello World");

app.Run();
```

#### http://+:3000

```csharp
var app = WebApplication.Create(args);

app.Urls.Add("http://+:3000");

app.MapGet("/", () => "Hello World");

app.Run();
```

#### `http://0.0.0.0:3000`

```csharp
var app = WebApplication.Create(args);

app.Urls.Add("http://0.0.0.0:3000");

app.MapGet("/", () => "Hello World");

app.Run();
```

### Listen on all interfaces using ASPNETCORE\_URLS

The preceding samples can use  `ASPNETCORE_URLS`

```
ASPNETCORE_URLS=http://*:3000;https://+:5000;http://0.0.0.0:5005
```

### Listen on all interfaces using ASPNETCORE\_HTTPS\_PORTS

The preceding samples can use  `ASPNETCORE_HTTPS_PORTS`  and  `ASPNETCORE_HTTP_PORTS` .

```
ASPNETCORE_HTTP_PORTS=3000;5005
ASPNETCORE_HTTPS_PORTS=5000
```

For more information, see [Configure endpoints for the ASP.NET Core Kestrel web server](https://learn.microsoft.com/en-us/aspnet/servers/kestrel/endpoints?view=aspnetcore-10.0)

### Specify HTTPS with development certificate

```csharp
var app = WebApplication.Create(args);

app.Urls.Add("https://localhost:3000");

app.MapGet("/", () => "Hello World");

app.Run();
```

For more information on the development certificate, see [Trust the ASP.NET Core HTTPS development certificate on Windows and macOS](https://learn.microsoft.com/en-us/security/enforcing-ssl?view=aspnetcore-10.0#trust).

### Specify HTTPS using a custom certificate

The following sections show how to specify the custom certificate using the  `appsettings.json`  file and via configuration.

#### Specify the custom certificate with `appsettings.json`

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "Kestrel": {
    "Certificates": {
      "Default": {
        "Path": "cert.pem",
        "KeyPath": "key.pem"
      }
    }
  }
}
```

#### Specify the custom certificate via configuration

```csharp
var builder = WebApplication.CreateBuilder(args);

// Configure the cert and the key
builder.Configuration["Kestrel:Certificates:Default:Path"] = "cert.pem";
builder.Configuration["Kestrel:Certificates:Default:KeyPath"] = "key.pem";

var app = builder.Build();

app.Urls.Add("https://localhost:3000");

app.MapGet("/", () => "Hello World");

app.Run();
```

#### Use the certificate APIs

```csharp
using System.Security.Cryptography.X509Certificates;

var builder = WebApplication.CreateBuilder(args);

builder.WebHost.ConfigureKestrel(options =>
{
    options.ConfigureHttpsDefaults(httpsOptions =>
    {
        var certPath = Path.Combine(builder.Environment.ContentRootPath, "cert.pem");
        var keyPath = Path.Combine(builder.Environment.ContentRootPath, "key.pem");

        httpsOptions.ServerCertificate = X509Certificate2.CreateFromPemFile(certPath, 
                                         keyPath);
    });
});

var app = builder.Build();

app.Urls.Add("https://localhost:3000");

app.MapGet("/", () => "Hello World");

app.Run();
```

### Read the environment

```csharp
var app = WebApplication.Create(args);

if (!app.Environment.IsDevelopment())
{
    app.UseExceptionHandler("/oops");
}

app.MapGet("/", () => "Hello World");
app.MapGet("/oops", () => "Oops! An error happened.");

app.Run();
```

For more information using the environment, see [ASP.NET Core runtime environments](https://learn.microsoft.com/en-us/aspnet/environments?view=aspnetcore-10.0)

### Configuration

The following code reads from the configuration system:

```csharp
var app = WebApplication.Create(args);

var message = app.Configuration["HelloKey"] ?? "Config failed!";

app.MapGet("/", () => message);

app.Run();
```

For more information, see [Configuration in ASP.NET Core](https://learn.microsoft.com/en-us/aspnet/configuration/?view=aspnetcore-10.0)

### Logging

The following code writes a message to the log on application startup:

```csharp
var app = WebApplication.Create(args);

app.Logger.LogInformation("The app started");

app.MapGet("/", () => "Hello World");

app.Run();
```

For more information, see [Logging in .NET and ASP.NET Core](https://learn.microsoft.com/en-us/aspnet/logging/?view=aspnetcore-10.0)

### Access the Dependency Injection (DI) container

The following code shows how to get services from the DI container during application startup:

```csharp
var builder = WebApplication.CreateBuilder(args);

builder.Services.AddControllers();
builder.Services.AddScoped<SampleService>();

var app = builder.Build();

app.MapControllers();

using (var scope = app.Services.CreateScope())
{
    var sampleService = scope.ServiceProvider.GetRequiredService<SampleService>();
    sampleService.DoSomething();
}

app.Run();
```

The following code shows how to access keys from the DI container using the [ `[FromKeyedServices]` ](https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.fromkeyedservicesattribute) attribute:

```csharp
var builder = WebApplication.CreateBuilder(args);

builder.Services.AddKeyedSingleton<ICache, BigCache>("big");
builder.Services.AddKeyedSingleton<ICache, SmallCache>("small");

var app = builder.Build();

app.MapGet("/big", ([FromKeyedServices("big")] ICache bigCache) => bigCache.Get("date"));

app.MapGet("/small", ([FromKeyedServices("small")] ICache smallCache) => smallCache.Get("date"));

app.Run();

public interface ICache
{
    object Get(string key);
}
public class BigCache : ICache
{
    public object Get(string key) => $"Resolving {key} from big cache.";
}

public class SmallCache : ICache
{
    public object Get(string key) => $"Resolving {key} from small cache.";
}
```

For more information on DI, see [Dependency injection in ASP.NET Core](https://learn.microsoft.com/en-us/aspnet/dependency-injection?view=aspnetcore-10.0).

## WebApplicationBuilder

This section contains sample code using [WebApplicationBuilder](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.webapplicationbuilder).

### Change the content root, application name, and environment

The following code sets the content root, application name, and environment:

```csharp
var builder = WebApplication.CreateBuilder(new WebApplicationOptions
{
    Args = args,
    ApplicationName = typeof(Program).Assembly.FullName,
    ContentRootPath = Directory.GetCurrentDirectory(),
    EnvironmentName = Environments.Staging,
    WebRootPath = "customwwwroot"
});

Console.WriteLine($"Application Name: {builder.Environment.ApplicationName}");
Console.WriteLine($"Environment Name: {builder.Environment.EnvironmentName}");
Console.WriteLine($"ContentRoot Path: {builder.Environment.ContentRootPath}");
Console.WriteLine($"WebRootPath: {builder.Environment.WebRootPath}");

var app = builder.Build();
```

[WebApplication.CreateBuilder](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.webapplication.createbuilder) initializes a new instance of the [WebApplicationBuilder](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.webapplicationbuilder) class with preconfigured defaults.

For more information, see [ASP.NET Core fundamentals overview](https://learn.microsoft.com/en-us/aspnet/?view=aspnetcore-10.0)

### Change the content root, app name, and environment by using environment variables or command line

The following table shows the environment variable and command-line argument used to change the content root, app name, and environment:

| feature | Environment variable | Command-line argument |
| --- | --- | --- |
| Application name | ASPNETCORE\_APPLICATIONNAME | --applicationName |
| Environment name | ASPNETCORE\_ENVIRONMENT | --environment |
| Content root | ASPNETCORE\_CONTENTROOT | --contentRoot |

### Add configuration providers

The following sample adds the INI configuration provider:

```csharp
var builder = WebApplication.CreateBuilder(args);

builder.Configuration.AddIniFile("appsettings.ini");

var app = builder.Build();
```

For detailed information, see [File configuration providers](https://learn.microsoft.com/en-us/aspnet/configuration/?view=aspnetcore-10.0#file-configuration-provider) in [Configuration in ASP.NET Core](https://learn.microsoft.com/en-us/aspnet/configuration/?view=aspnetcore-10.0).

### Read configuration

By default the [WebApplicationBuilder](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.webapplicationbuilder) reads configuration from multiple sources, including:

* `appSettings.json`  and  `appSettings.{environment}.json`
* Environment variables
* The command line

For a complete list of configuration sources read, see [Default configuration](https://learn.microsoft.com/en-us/aspnet/configuration/?view=aspnetcore-10.0#default-configuration) in [Configuration in ASP.NET Core](https://learn.microsoft.com/en-us/aspnet/configuration/?view=aspnetcore-10.0).

The following code reads  `HelloKey`  from configuration and displays the value at the  `/`  endpoint. If the configuration value is null, "Hello" is assigned to  `message` :

```csharp
var builder = WebApplication.CreateBuilder(args);

var message = builder.Configuration["HelloKey"] ?? "Hello";

var app = builder.Build();

app.MapGet("/", () => message);

app.Run();
```

### Read the environment

```csharp
var builder = WebApplication.CreateBuilder(args);

if (builder.Environment.IsDevelopment())
{
    Console.WriteLine($"Running in development.");
}

var app = builder.Build();

app.MapGet("/", () => "Hello World!");

app.Run();
```

### Add logging providers

```csharp
var builder = WebApplication.CreateBuilder(args);

// Configure JSON logging to the console.
builder.Logging.AddJsonConsole();

var app = builder.Build();

app.MapGet("/", () => "Hello JSON console!");

app.Run();
```

### Add services

```csharp
var builder = WebApplication.CreateBuilder(args);

// Add the memory cache services.
builder.Services.AddMemoryCache();

// Add a custom scoped service.
builder.Services.AddScoped<ITodoRepository, TodoRepository>();
var app = builder.Build();
```

### Customize the IHostBuilder

Existing extension methods on [IHostBuilder](https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.hosting.ihostbuilder) can be accessed using the [Host property](https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.hosting.ihostbuilder.properties#microsoft-extensions-hosting-ihostbuilder-properties):

```csharp
var builder = WebApplication.CreateBuilder(args);

// Wait 30 seconds for graceful shutdown.
builder.Host.ConfigureHostOptions(o => o.ShutdownTimeout = TimeSpan.FromSeconds(30));

var app = builder.Build();

app.MapGet("/", () => "Hello World!");

app.Run();
```

### Customize the IWebHostBuilder

Extension methods on [IWebHostBuilder](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.iwebhostbuilder) can be accessed using the [WebApplicationBuilder.WebHost](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.webapplicationbuilder.webhost#microsoft-aspnetcore-builder-webapplicationbuilder-webhost) property.

```csharp
var builder = WebApplication.CreateBuilder(args);

// Change the HTTP server implemenation to be HTTP.sys based
builder.WebHost.UseHttpSys();

var app = builder.Build();

app.MapGet("/", () => "Hello HTTP.sys");

app.Run();
```

### Change the web root

By default, the web root is relative to the content root in the  `wwwroot`  folder. Web root is where the Static File Middleware looks for static files. Web root can be changed with  `WebHostOptions` , the command line, or with the [UseWebRoot](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.hostingabstractionswebhostbuilderextensions.usewebroot) method:

```csharp
var builder = WebApplication.CreateBuilder(new WebApplicationOptions
{
    Args = args,
    // Look for static files in webroot
    WebRootPath = "webroot"
});

var app = builder.Build();

app.Run();
```

### Custom dependency injection (DI) container

The following example uses [Autofac](https://autofac.readthedocs.io/en/latest/integration/aspnetcore.html):

```csharp
var builder = WebApplication.CreateBuilder(args);

builder.Host.UseServiceProviderFactory(new AutofacServiceProviderFactory());

// Register services directly with Autofac here. Don't
// call builder.Populate(), that happens in AutofacServiceProviderFactory.
builder.Host.ConfigureContainer<ContainerBuilder>(builder => builder.RegisterModule(new MyApplicationModule()));

var app = builder.Build();
```

### Add Middleware

Any existing ASP.NET Core middleware can be configured on the  `WebApplication` :

```csharp
var app = WebApplication.Create(args);

// Setup the file server to serve static files.
app.UseFileServer();

app.MapGet("/", () => "Hello World!");

app.Run();
```

For more information, see [ASP.NET Core Middleware](https://learn.microsoft.com/en-us/aspnet/middleware/?view=aspnetcore-10.0)

### Developer exception page

[WebApplication.CreateBuilder](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.webapplication.createbuilder) initializes a new instance of the [WebApplicationBuilder](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.webapplicationbuilder) class with preconfigured defaults. The developer exception page is enabled in the preconfigured defaults. When the following code is run in the [development environment](https://learn.microsoft.com/en-us/aspnet/environments?view=aspnetcore-10.0), navigating to  `/`  renders a friendly page that shows the exception.

```csharp
var builder = WebApplication.CreateBuilder(args);

var app = builder.Build();

app.MapGet("/", () =>
{
    throw new InvalidOperationException("Oops, the '/' route has thrown an exception.");
});

app.Run();
```