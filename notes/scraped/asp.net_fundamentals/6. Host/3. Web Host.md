# ASP.NET Core Web Host

ASP.NET Core apps configure and launch a *host*. The host is responsible for app startup and lifetime management. At a minimum, the host configures a server and a request processing pipeline. The host can also set up logging, dependency injection, and configuration.

This article covers the Web Host, which remains available only for backward compatibility. The ASP.NET Core templates create a [WebApplicationBuilder](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.webapplicationbuilder) and [WebApplication](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.webapplication), which is recommended for web apps. For more information on  `WebApplicationBuilder`  and  `WebApplication` , see [Migrate from ASP.NET Core in .NET 5 to .NET 6](https://learn.microsoft.com/en-us/migration/50-to-60?view=aspnetcore-10.0#new-hosting-model)

## Set up a host

Create a host using an instance of [IWebHostBuilder](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.iwebhostbuilder). This is typically performed in the app's entry point, the  `Main`  method in  `Program.cs` . A typical app calls [CreateDefaultBuilder](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.webhost.createdefaultbuilder) to start setting up a host:

```csharp
public class Program
{
    public static void Main(string[] args)
    {
        CreateWebHostBuilder(args).Build().Run();
    }

    public static IWebHostBuilder CreateWebHostBuilder(string[] args) =>
        WebHost.CreateDefaultBuilder(args)
            .UseStartup<Startup>();
}
```

The code that calls  `CreateDefaultBuilder`  is in a method named  `CreateWebHostBuilder` , which separates it from the code in  `Main`  that calls  `Run`  on the builder object. This separation is required if you use [Entity Framework Core tools](https://learn.microsoft.com/en-us/ef/core/miscellaneous/cli/). The tools expect to find a  `CreateWebHostBuilder`  method that they can call at design time to configure the host without running the app. An alternative is to implement  `IDesignTimeDbContextFactory` . For more information, see [Design-time DbContext Creation](https://learn.microsoft.com/en-us/ef/core/miscellaneous/cli/dbcontext-creation).

`CreateDefaultBuilder`  performs the following tasks:

* Configures [Kestrel](https://learn.microsoft.com/en-us/aspnet/servers/kestrel?view=aspnetcore-10.0) server as the web server using the app's hosting configuration providers. For the Kestrel server's default options, see [Configure options for the ASP.NET Core Kestrel web server](https://learn.microsoft.com/en-us/aspnet/servers/kestrel/options?view=aspnetcore-10.0).
* Sets the [content root](https://learn.microsoft.com/en-us/aspnet/?view=aspnetcore-10.0#content-root) to the path returned by [Directory.GetCurrentDirectory](https://learn.microsoft.com/en-us/dotnet/api/system.io.directory.getcurrentdirectory).
* Loads [host configuration](https://learn.microsoft.com/en-us/aspnet/core/#host-configuration-values) from:
  + Environment variables prefixed with  `ASPNETCORE_`  (for example,  `ASPNETCORE_ENVIRONMENT` ).
  + Command-line arguments.
* Loads app configuration in the following order from:
  + `appsettings.json` .
  + `appsettings.{Environment}.json` .
  + [User secrets](https://learn.microsoft.com/en-us/security/app-secrets?view=aspnetcore-10.0) when the app runs in the  `Development`  environment using the entry assembly.
  + Environment variables.
  + Command-line arguments.
* Configures [logging](https://learn.microsoft.com/en-us/aspnet/logging/?view=aspnetcore-10.0) for console and debug output. Logging includes [log filtering](https://learn.microsoft.com/en-us/aspnet/logging/?view=aspnetcore-10.0#apply-log-filter-rules-in-code) rules specified in a Logging configuration section of an  `appsettings.json`  or  `appsettings.{Environment}.json`  file.
* When running behind IIS with the [ASP.NET Core Module](https://learn.microsoft.com/en-us/host-and-deploy/aspnet-core-module?view=aspnetcore-10.0),  `CreateDefaultBuilder`  enables [IIS Integration](https://learn.microsoft.com/en-us/host-and-deploy/iis/?view=aspnetcore-10.0), which configures the app's base address and port. IIS Integration also configures the app to [capture startup errors](https://learn.microsoft.com/en-us/aspnet/core/#capture-startup-errors). For the IIS default options, see [Host ASP.NET Core on Windows with IIS](https://learn.microsoft.com/en-us/host-and-deploy/iis/?view=aspnetcore-10.0#iis-options).
* Sets [ServiceProviderOptions.ValidateScopes](https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.serviceprovideroptions.validatescopes) to  `true`  if the app's environment is  `Development` . For more information, see [Scope validation](https://learn.microsoft.com/en-us/aspnet/core/#scope-validation).

The configuration defined by  `CreateDefaultBuilder`  can be overridden and augmented by [ConfigureAppConfiguration](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.webhostbuilderextensions.configureappconfiguration), [ConfigureLogging](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.webhostbuilderextensions.configurelogging), and other methods and extension methods of [IWebHostBuilder](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.iwebhostbuilder). A few examples follow:

* [ConfigureAppConfiguration](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.webhostbuilderextensions.configureappconfiguration) is used to specify additional  `IConfiguration`  for the app. The following  `ConfigureAppConfiguration`  call adds a delegate to include app configuration in the  `appsettings.xml`  file.  `ConfigureAppConfiguration`  may be called multiple times. Note that this configuration doesn't apply to the host (for example, server URLs or environment). See the [Host configuration values](https://learn.microsoft.com/en-us/aspnet/core/#host-configuration-values) section.

  ```csharp
  WebHost.CreateDefaultBuilder(args)
      .ConfigureAppConfiguration((hostingContext, config) =>
      {
          config.AddXmlFile("appsettings.xml", optional: true, reloadOnChange: true);
      })
      ...
  ```
* The following  `ConfigureLogging`  call adds a delegate to configure the minimum logging level ([SetMinimumLevel](https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.logging.loggingbuilderextensions.setminimumlevel)) to [LogLevel.Warning](https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.logging.loglevel#microsoft-extensions-logging-loglevel-warning). This setting overrides the settings in  `appsettings.Development.json`  ( `LogLevel.Debug` ) and  `appsettings.Production.json`  ( `LogLevel.Error` ) configured by  `CreateDefaultBuilder` .  `ConfigureLogging`  may be called multiple times.

  ```csharp
  WebHost.CreateDefaultBuilder(args)
      .ConfigureLogging(logging => 
      {
          logging.SetMinimumLevel(LogLevel.Warning);
      })
      ...
  ```
* The following call to  `ConfigureKestrel`  overrides the default [Limits.MaxRequestBodySize](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.server.kestrel.core.kestrelserverlimits.maxrequestbodysize) of 30,000,000 bytes established when Kestrel was configured by  `CreateDefaultBuilder` :

  ```csharp
  WebHost.CreateDefaultBuilder(args)
      .ConfigureKestrel((context, options) =>
      {
          options.Limits.MaxRequestBodySize = 20000000;
      });
  ```

The [content root](https://learn.microsoft.com/en-us/aspnet/?view=aspnetcore-10.0#content-root) determines where the host searches for content files, such as MVC view files. When the app is started from the project's root folder, the project's root folder is used as the content root. This is the default used in [Visual Studio](https://visualstudio.microsoft.com) and the [dotnet new templates](https://learn.microsoft.com/en-us/dotnet/core/tools/dotnet-new).

For more information on app configuration, see [Configuration in ASP.NET Core](https://learn.microsoft.com/en-us/aspnet/configuration/?view=aspnetcore-10.0).

> [!NOTE]
> As an alternative to using the static  `CreateDefaultBuilder`  method, creating a host from [WebHostBuilder](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.webhostbuilder) is a supported approach with ASP.NET Core 2.x.

When setting up a host, [Configure](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.webhostbuilderextensions.configure) and [ConfigureServices](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.webhostbuilder.configureservices) methods can be provided. If a  `Startup`  class is specified, it must define a  `Configure`  method. For more information, see [App startup in ASP.NET Core](https://learn.microsoft.com/en-us/aspnet/startup?view=aspnetcore-10.0). Multiple calls to  `ConfigureServices`  append to one another. Multiple calls to  `Configure`  or  `UseStartup`  on the  `WebHostBuilder`  replace previous settings.

## Host configuration values

[WebHostBuilder](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.webhostbuilder) relies on the following approaches to set the host configuration values:

* Host builder configuration, which includes environment variables with the format  `ASPNETCORE_{configurationKey}` . For example,  `ASPNETCORE_ENVIRONMENT` .
* Extensions such as [UseContentRoot](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.hostingabstractionswebhostbuilderextensions.usecontentroot) and [UseConfiguration](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.hostingabstractionswebhostbuilderextensions.useconfiguration) (see the [Override configuration](https://learn.microsoft.com/en-us/aspnet/core/#override-configuration) section).
* [UseSetting](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.webhostbuilder.usesetting) and the associated key. When setting a value with  `UseSetting` , the value is set as a string regardless of the type.

The host uses whichever option sets a value last. For more information, see [Override configuration](https://learn.microsoft.com/en-us/aspnet/core/#override-configuration) in the next section.

### Application Key (Name)

The  `IWebHostEnvironment.ApplicationName`  property is automatically set when [UseStartup](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.webhostbuilderextensions.usestartup) or [Configure](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.istartup.configure) is called during host construction. The value is set to the name of the assembly containing the app's entry point. To set the value explicitly, use the [WebHostDefaults.ApplicationKey](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.webhostdefaults.applicationkey#microsoft-aspnetcore-hosting-webhostdefaults-applicationkey):

**Key**: applicationName  
**Type**: *string*  
**Default**: The name of the assembly containing the app's entry point.  
**Set using**:  `UseSetting`   
**Environment variable**:  `ASPNETCORE_APPLICATIONNAME`

```csharp
WebHost.CreateDefaultBuilder(args)
    .UseSetting(WebHostDefaults.ApplicationKey, "CustomApplicationName")
```

### Capture Startup Errors

This setting controls the capture of startup errors.

**Key**: captureStartupErrors  
**Type**: *bool* ( `true`  or  `1` )  
**Default**: Defaults to  `false`  unless the app runs with Kestrel behind IIS, where the default is  `true` .  
**Set using**:  `CaptureStartupErrors`   
**Environment variable**:  `ASPNETCORE_CAPTURESTARTUPERRORS`

When  `false` , errors during startup result in the host exiting. When  `true` , the host captures exceptions during startup and attempts to start the server.

```csharp
WebHost.CreateDefaultBuilder(args)
    .CaptureStartupErrors(true)
```

### Content root

This setting determines where ASP.NET Core begins searching for content files.

**Key**: contentRoot  
**Type**: *string*  
**Default**: Defaults to the folder where the app assembly resides.  
**Set using**:  `UseContentRoot`   
**Environment variable**:  `ASPNETCORE_CONTENTROOT`

The content root is also used as the base path for the [web root](https://learn.microsoft.com/en-us/aspnet/?view=aspnetcore-10.0#web-root). If the content root path doesn't exist, the host fails to start.

```csharp
WebHost.CreateDefaultBuilder(args)
    .UseContentRoot("c:\\<content-root>")
```

For more information, see:

* [Fundamentals: Content root](https://learn.microsoft.com/en-us/aspnet/?view=aspnetcore-10.0#content-root)
* [Web root](https://learn.microsoft.com/en-us/aspnet/core/#web-root)

### Detailed Errors

Determines if detailed errors should be captured.

**Key**: detailedErrors  
**Type**: *bool* ( `true`  or  `1` )  
**Default**: false  
**Set using**:  `UseSetting`   
**Environment variable**:  `ASPNETCORE_DETAILEDERRORS`

When enabled (or when the [Environment](https://learn.microsoft.com/en-us/aspnet/core/#environment) is set to  `Development` ), the app captures detailed exceptions.

```csharp
WebHost.CreateDefaultBuilder(args)
    .UseSetting(WebHostDefaults.DetailedErrorsKey, "true")
```

### Environment

Sets the app's environment.

**Key**: environment  
**Type**: *string*  
**Default**: Production  
**Set using**:  `UseEnvironment`   
**Environment variable**:  `ASPNETCORE_ENVIRONMENT`

The environment can be set to any value. Framework-defined values include  `Development` ,  `Staging` , and  `Production` . Values aren't case sensitive. By default, the *Environment* is read from the  `ASPNETCORE_ENVIRONMENT`  environment variable. When using [Visual Studio](https://visualstudio.microsoft.com), environment variables may be set in the  `launchSettings.json`  file. For more information, see [ASP.NET Core runtime environments](https://learn.microsoft.com/en-us/aspnet/environments?view=aspnetcore-10.0).

```csharp
WebHost.CreateDefaultBuilder(args)
    .UseEnvironment(EnvironmentName.Development)
```

### Hosting Startup Assemblies

Sets the app's hosting startup assemblies.

**Key**: hostingStartupAssemblies  
**Type**: *string*  
**Default**: Empty string  
**Set using**:  `UseSetting`   
**Environment variable**:  `ASPNETCORE_HOSTINGSTARTUPASSEMBLIES`

A semicolon-delimited string of hosting startup assemblies to load on startup.

Although the configuration value defaults to an empty string, the hosting startup assemblies always include the app's assembly. When hosting startup assemblies are provided, they're added to the app's assembly for loading when the app builds its common services during startup.

```csharp
WebHost.CreateDefaultBuilder(args)
    .UseSetting(WebHostDefaults.HostingStartupAssembliesKey, "assembly1;assembly2")
```

### HTTPS Port

Set the HTTPS port to redirect to if you get a non-HTTPS connection. Used in [enforcing HTTPS](https://learn.microsoft.com/en-us/security/enforcing-ssl?view=aspnetcore-10.0). This setting doesn't cause the server to listen on the specified port. That is, it's possible to accidentally redirect requests to an unused port.

**Key**: https\_port  
**Type**: *string*  
**Default**: A default value isn't set.  
**Set using**:  `UseSetting`   
**Environment variable**:  `ASPNETCORE_HTTPS_PORT`

```csharp
WebHost.CreateDefaultBuilder(args)
    .UseSetting("https_port", "8080")
```

### HTTPS Ports

Set the ports to listen on for HTTPS connections.

**Key**: https\_ports
**Type**: *string*  
**Default**: A default value isn't set.  
**Set using**:  `UseSetting`   
**Environment variable**:  `ASPNETCORE_HTTPS_PORTS`

```csharp
WebHost.CreateDefaultBuilder(args)
    .UseSetting("https_ports", "8080")
```

### HTTP Ports

Set the ports to listen on for HTTP connections.

**Key**: http\_ports
**Type**: *string*  
**Default**: A default value isn't set.  
**Set using**:  `UseSetting`   
**Environment variable**:  `ASPNETCORE_HTTP_PORTS`

```csharp
WebHost.CreateDefaultBuilder(args)
    .UseSetting("http_ports", "8080")
```

### Hosting Startup Exclude Assemblies

A semicolon-delimited string of hosting startup assemblies to exclude on startup.

**Key**: hostingStartupExcludeAssemblies  
**Type**: *string*  
**Default**: Empty string  
**Set using**:  `UseSetting`   
**Environment variable**:  `ASPNETCORE_HOSTINGSTARTUPEXCLUDEASSEMBLIES`

```csharp
WebHost.CreateDefaultBuilder(args)
    .UseSetting(WebHostDefaults.HostingStartupExcludeAssembliesKey, "assembly1;assembly2")
```

### Prefer Hosting URLs

Indicates whether the host should listen on the URLs configured with the  `WebHostBuilder`  instead of those configured with the  `IServer`  implementation.

**Key**: preferHostingUrls  
**Type**: *bool* ( `true`  or  `1` )  
**Default**: false  
**Set using**:  `PreferHostingUrls`   
**Environment variable**:  `ASPNETCORE_PREFERHOSTINGURLS`

```csharp
WebHost.CreateDefaultBuilder(args)
    .PreferHostingUrls(true)
```

### Prevent Hosting Startup

Prevents the automatic loading of hosting startup assemblies, including hosting startup assemblies configured by the app's assembly. For more information, see [Use hosting startup assemblies in ASP.NET Core](https://learn.microsoft.com/en-us/aspnet/core/platform-specific-configuration?view=aspnetcore-10.0).

**Key**: preventHostingStartup  
**Type**: *bool* ( `true`  or  `1` )  
**Default**: false  
**Set using**:  `UseSetting`   
**Environment variable**:  `ASPNETCORE_PREVENTHOSTINGSTARTUP`

```csharp
WebHost.CreateDefaultBuilder(args)
    .UseSetting(WebHostDefaults.PreventHostingStartupKey, "true")
```

### Server URLs

Indicates the IP addresses or host addresses with ports and protocols that the server should listen on for requests.

**Key**: urls  
**Type**: *string*  
**Default**: http://localhost:5000  
**Set using**:  `UseUrls`   
**Environment variable**:  `ASPNETCORE_URLS`

Set to a semicolon-separated (;) list of URL prefixes to which the server should respond. For example,  `http://localhost:123` . Use "\*" to indicate that the server should listen for requests on any IP address or hostname using the specified port and protocol (for example,  `http://*:5000` ). The protocol ( `http://`  or  `https://` ) must be included with each URL. Supported formats vary among servers.

```csharp
WebHost.CreateDefaultBuilder(args)
    .UseUrls("http://*:5000;http://localhost:5001;https://hostname:5002")
```

Kestrel has its own endpoint configuration API. For more information, see [Configure endpoints for the ASP.NET Core Kestrel web server](https://learn.microsoft.com/en-us/aspnet/servers/kestrel/endpoints?view=aspnetcore-10.0).

### Shutdown Timeout

Specifies the amount of time to wait for Web Host to shut down.

**Key**: shutdownTimeoutSeconds  
**Type**: *int*  
**Default**: 5  
**Set using**:  `UseShutdownTimeout`   
**Environment variable**:  `ASPNETCORE_SHUTDOWNTIMEOUTSECONDS`

Although the key accepts an *int* with  `UseSetting`  (for example,  `.UseSetting(WebHostDefaults.ShutdownTimeoutKey, "10")` ), the [UseShutdownTimeout](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.hostingabstractionswebhostbuilderextensions.useshutdowntimeout) extension method takes a [TimeSpan](https://learn.microsoft.com/en-us/dotnet/api/system.timespan).

During the timeout period, hosting:

* Triggers [IApplicationLifetime.ApplicationStopping](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.iapplicationlifetime.applicationstopping).
* Attempts to stop hosted services, logging any errors for services that fail to stop.

If the timeout period expires before all of the hosted services stop, any remaining active services are stopped when the app shuts down. The services stop even if they haven't finished processing. If services require additional time to stop, increase the timeout.

```csharp
WebHost.CreateDefaultBuilder(args)
    .UseShutdownTimeout(TimeSpan.FromSeconds(10))
```

### Startup Assembly

Determines the assembly to search for the  `Startup`  class.

**Key**: startupAssembly  
**Type**: *string*  
**Default**: The app's assembly  
**Set using**:  `UseStartup`   
**Environment variable**:  `ASPNETCORE_STARTUPASSEMBLY`

The assembly by name ( `string` ) or type ( `TStartup` ) can be referenced. If multiple  `UseStartup`  methods are called, the last one takes precedence.

```csharp
WebHost.CreateDefaultBuilder(args)
    .UseStartup("StartupAssemblyName")
```

```csharp
WebHost.CreateDefaultBuilder(args)
    .UseStartup<TStartup>()
```

### Web root

Sets the relative path to the app's static assets.

**Key**: webroot  
**Type**: *string*  
**Default**: The default is  `wwwroot` . The path to *{content root}/wwwroot* must exist. If the path doesn't exist, a no-op file provider is used.  
**Set using**:  `UseWebRoot`   
**Environment variable**:  `ASPNETCORE_WEBROOT`

```csharp
WebHost.CreateDefaultBuilder(args)
    .UseWebRoot("public")
```

For more information, see:

* [Fundamentals: Web root](https://learn.microsoft.com/en-us/aspnet/?view=aspnetcore-10.0#web-root)
* [Content root](https://learn.microsoft.com/en-us/aspnet/core/#content-root)

## Override configuration

Use [Configuration](https://learn.microsoft.com/en-us/aspnet/configuration/?view=aspnetcore-10.0) to configure Web Host. In the following example, host configuration is optionally specified in a  `hostsettings.json`  file. Any configuration loaded from the  `hostsettings.json`  file may be overridden by command-line arguments. The built configuration (in  `config` ) is used to configure the host with [UseConfiguration](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.hostingabstractionswebhostbuilderextensions.useconfiguration).  `IWebHostBuilder`  configuration is added to the app's configuration, but the converse isn't trueâ `ConfigureAppConfiguration`  doesn't affect the  `IWebHostBuilder`  configuration.

Overriding the configuration provided by  `UseUrls`  with  `hostsettings.json`  config first, command-line argument config second:

```csharp
public class Program
{
    public static void Main(string[] args)
    {
        CreateWebHostBuilder(args).Build().Run();
    }

    public static IWebHostBuilder CreateWebHostBuilder(string[] args)
    {
        var config = new ConfigurationBuilder()
            .SetBasePath(Directory.GetCurrentDirectory())
            .AddJsonFile("hostsettings.json", optional: true)
            .AddCommandLine(args)
            .Build();

        return WebHost.CreateDefaultBuilder(args)
            .UseUrls("http://*:5000")
            .UseConfiguration(config)
            .Configure(app =>
            {
                app.Run(context => 
                    context.Response.WriteAsync("Hello, World!"));
            });
    }
}
```

`hostsettings.json` :

```json
{
    urls: "http://*:5005"
}
```

> [!NOTE]
> [UseConfiguration](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.hostingabstractionswebhostbuilderextensions.useconfiguration) only copies keys from the provided  `IConfiguration`  to the host builder configuration. Therefore, setting  `reloadOnChange: true`  for JSON, INI, and XML settings files has no effect.

To specify the host run on a particular URL, the desired value can be passed in from a command prompt when executing [dotnet run](https://learn.microsoft.com/en-us/dotnet/core/tools/dotnet-run). The command-line argument overrides the  `urls`  value from the  `hostsettings.json`  file, and the server listens on port 8080:

```dotnetcli
dotnet run --urls "http://*:8080"
```

## Manage the host

**Run**

The  `Run`  method starts the web app and blocks the calling thread until the host is shut down:

```csharp
host.Run();
```

**Start**

Run the host in a non-blocking manner by calling its  `Start`  method:

```csharp
using (host)
{
    host.Start();
    Console.ReadLine();
}
```

If a list of URLs is passed to the  `Start`  method, it listens on the URLs specified:

```csharp
var urls = new List<string>()
{
    "http://*:5000",
    "http://localhost:5001"
};

var host = new WebHostBuilder()
    .UseKestrel()
    .UseStartup<Startup>()
    .Start(urls.ToArray());

using (host)
{
    Console.ReadLine();
}
```

The app can initialize and start a new host using the pre-configured defaults of  `CreateDefaultBuilder`  using a static convenience method. These methods start the server without console output and with [WaitForShutdown](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.webhostextensions.waitforshutdown) wait for a break (Ctrl-C/SIGINT or SIGTERM):

**Start(RequestDelegate app)**

Start with a  `RequestDelegate` :

```csharp
using (var host = WebHost.Start(app => app.Response.WriteAsync("Hello, World!")))
{
    Console.WriteLine("Use Ctrl-C to shutdown the host...");
    host.WaitForShutdown();
}
```

Make a request in the browser to  `http://localhost:5000`  to receive the response "Hello World!"  `WaitForShutdown`  blocks until a break (Ctrl-C/SIGINT or SIGTERM) is issued. The app displays the  `Console.WriteLine`  message and waits for a keypress to exit.

**Start(string url, RequestDelegate app)**

Start with a URL and  `RequestDelegate` :

```csharp
using (var host = WebHost.Start("http://localhost:8080", app => app.Response.WriteAsync("Hello, World!")))
{
    Console.WriteLine("Use Ctrl-C to shutdown the host...");
    host.WaitForShutdown();
}
```

Produces the same result as **Start(RequestDelegate app)**, except the app responds on  `http://localhost:8080` .

**Start(Action<IRouteBuilder> routeBuilder)**

Use an instance of  `IRouteBuilder`  ([Microsoft.AspNetCore.Routing](https://www.nuget.org/packages/Microsoft.AspNetCore.Routing/)) to use routing middleware:

```csharp
using (var host = WebHost.Start(router => router
    .MapGet("hello/{name}", (req, res, data) => 
        res.WriteAsync($"Hello, {data.Values["name"]}!"))
    .MapGet("buenosdias/{name}", (req, res, data) => 
        res.WriteAsync($"Buenos dias, {data.Values["name"]}!"))
    .MapGet("throw/{message?}", (req, res, data) => 
        throw new Exception((string)data.Values["message"] ?? "Uh oh!"))
    .MapGet("{greeting}/{name}", (req, res, data) => 
        res.WriteAsync($"{data.Values["greeting"]}, {data.Values["name"]}!"))
    .MapGet("", (req, res, data) => res.WriteAsync("Hello, World!"))))
{
    Console.WriteLine("Use Ctrl-C to shutdown the host...");
    host.WaitForShutdown();
}
```

Use the following browser requests with the example:

| Request | Response |
| --- | --- |
| `http://localhost:5000/hello/Martin` | Hello, Martin! |
| `http://localhost:5000/buenosdias/Catrina` | Buenos dias, Catrina! |
| `http://localhost:5000/throw/ooops!` | Throws an exception with string "ooops!" |
| `http://localhost:5000/throw` | Throws an exception with string "Uh oh!" |
| `http://localhost:5000/Sante/Kevin` | Sante, Kevin! |
| `http://localhost:5000` | Hello World! |

`WaitForShutdown`  blocks until a break (Ctrl-C/SIGINT or SIGTERM) is issued. The app displays the  `Console.WriteLine`  message and waits for a keypress to exit.

**Start(string url, Action<IRouteBuilder> routeBuilder)**

Use a URL and an instance of  `IRouteBuilder` :

```csharp
using (var host = WebHost.Start("http://localhost:8080", router => router
    .MapGet("hello/{name}", (req, res, data) => 
        res.WriteAsync($"Hello, {data.Values["name"]}!"))
    .MapGet("buenosdias/{name}", (req, res, data) => 
        res.WriteAsync($"Buenos dias, {data.Values["name"]}!"))
    .MapGet("throw/{message?}", (req, res, data) => 
        throw new Exception((string)data.Values["message"] ?? "Uh oh!"))
    .MapGet("{greeting}/{name}", (req, res, data) => 
        res.WriteAsync($"{data.Values["greeting"]}, {data.Values["name"]}!"))
    .MapGet("", (req, res, data) => res.WriteAsync("Hello, World!"))))
{
    Console.WriteLine("Use Ctrl-C to shut down the host...");
    host.WaitForShutdown();
}
```

Produces the same result as **Start(Action<IRouteBuilder> routeBuilder)**, except the app responds at  `http://localhost:8080` .

**StartWith(Action<IApplicationBuilder> app)**

Provide a delegate to configure an  `IApplicationBuilder` :

```csharp
using (var host = WebHost.StartWith(app => 
    app.Use(next => 
    {
        return async context => 
        {
            await context.Response.WriteAsync("Hello World!");
        };
    })))
{
    Console.WriteLine("Use Ctrl-C to shut down the host...");
    host.WaitForShutdown();
}
```

Make a request in the browser to  `http://localhost:5000`  to receive the response "Hello World!"  `WaitForShutdown`  blocks until a break (Ctrl-C/SIGINT or SIGTERM) is issued. The app displays the  `Console.WriteLine`  message and waits for a keypress to exit.

**StartWith(string url, Action<IApplicationBuilder> app)**

Provide a URL and a delegate to configure an  `IApplicationBuilder` :

```csharp
using (var host = WebHost.StartWith("http://localhost:8080", app => 
    app.Use(next => 
    {
        return async context => 
        {
            await context.Response.WriteAsync("Hello World!");
        };
    })))
{
    Console.WriteLine("Use Ctrl-C to shut down the host...");
    host.WaitForShutdown();
}
```

Produces the same result as **StartWith(Action<IApplicationBuilder> app)**, except the app responds on  `http://localhost:8080` .

## IWebHostEnvironment interface

The  `IWebHostEnvironment`  interface provides information about the app's web hosting environment. Use [constructor injection](https://learn.microsoft.com/en-us/aspnet/dependency-injection?view=aspnetcore-10.0) to obtain the  `IWebHostEnvironment`  in order to use its properties and extension methods:

```csharp
public class CustomFileReader
{
    private readonly IWebHostEnvironment _env;

    public CustomFileReader(IWebHostEnvironment env)
    {
        _env = env;
    }

    public string ReadFile(string filePath)
    {
        var fileProvider = _env.WebRootFileProvider;
        // Process the file here
    }
}
```

A [convention-based approach](https://learn.microsoft.com/en-us/aspnet/environments?view=aspnetcore-10.0#environment-based-startup-class-and-methods) can be used to configure the app at startup based on the environment. Alternatively, inject the  `IWebHostEnvironment`  into the  `Startup`  constructor for use in  `ConfigureServices` :

```csharp
public class Startup
{
    public Startup(IWebHostEnvironment env)
    {
        HostingEnvironment = env;
    }

    public IWebHostEnvironment HostingEnvironment { get; }

    public void ConfigureServices(IServiceCollection services)
    {
        if (HostingEnvironment.IsDevelopment())
        {
            // Development configuration
        }
        else
        {
            // Staging/Production configuration
        }

        var contentRootPath = HostingEnvironment.ContentRootPath;
    }
}
```

> [!NOTE]
> In addition to the  `IsDevelopment`  extension method,  `IWebHostEnvironment`  offers  `IsStaging` ,  `IsProduction` , and  `IsEnvironment(string environmentName)`  methods. For more information, see [ASP.NET Core runtime environments](https://learn.microsoft.com/en-us/aspnet/environments?view=aspnetcore-10.0).

The  `IWebHostEnvironment`  service can also be injected directly into the  `Configure`  method for setting up the processing pipeline:

```csharp
public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
{
    if (env.IsDevelopment())
    {
        // In Development, use the Developer Exception Page
        app.UseDeveloperExceptionPage();
    }
    else
    {
        // In Staging/Production, route exceptions to /error
        app.UseExceptionHandler("/error");
    }

    var contentRootPath = env.ContentRootPath;
}
```

`IWebHostEnvironment`  can be injected into the  `Invoke`  method when creating custom [middleware](https://learn.microsoft.com/en-us/aspnet/middleware/write?view=aspnetcore-10.0):

```csharp
public async Task Invoke(HttpContext context, IWebHostEnvironment env)
{
    if (env.IsDevelopment())
    {
        // Configure middleware for Development
    }
    else
    {
        // Configure middleware for Staging/Production
    }

    var contentRootPath = env.ContentRootPath;
}
```

## IHostApplicationLifetime interface

`IHostApplicationLifetime`  allows for post-startup and shutdown activities. Three properties on the interface are cancellation tokens used to register  `Action`  methods that define startup and shutdown events.

| Cancellation Token | Triggered whenâ¦ |
| --- | --- |
| `ApplicationStarted` | The host has fully started. |
| `ApplicationStopped` | The host is completing a graceful shutdown. All requests should be processed. Shutdown blocks until this event completes. |
| `ApplicationStopping` | The host is performing a graceful shutdown. Requests may still be processing. Shutdown blocks until this event completes. |

```csharp
public class Startup
{
    public void Configure(IApplicationBuilder app, IHostApplicationLifetime appLifetime)
    {
        appLifetime.ApplicationStarted.Register(OnStarted);
        appLifetime.ApplicationStopping.Register(OnStopping);
        appLifetime.ApplicationStopped.Register(OnStopped);

        Console.CancelKeyPress += (sender, eventArgs) =>
        {
            appLifetime.StopApplication();
            // Don't terminate the process immediately, wait for the Main thread to exit gracefully.
            eventArgs.Cancel = true;
        };
    }

    private void OnStarted()
    {
        // Perform post-startup activities here
    }

    private void OnStopping()
    {
        // Perform on-stopping activities here
    }

    private void OnStopped()
    {
        // Perform post-stopped activities here
    }
}
```

`StopApplication`  requests termination of the app. The following class uses  `StopApplication`  to gracefully shut down an app when the class's  `Shutdown`  method is called:

```csharp
public class MyClass
{
    private readonly IHostApplicationLifetime _appLifetime;

    public MyClass(IHostApplicationLifetime appLifetime)
    {
        _appLifetime = appLifetime;
    }

    public void Shutdown()
    {
        _appLifetime.StopApplication();
    }
}
```

## Scope validation

[CreateDefaultBuilder](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.webhost.createdefaultbuilder) sets [ServiceProviderOptions.ValidateScopes](https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.serviceprovideroptions.validatescopes) to  `true`  if the app's environment is  `Development` .

When  `ValidateScopes`  is set to  `true` , the default service provider performs checks to verify that:

* Scoped services aren't directly or indirectly resolved from the root service provider.
* Scoped services aren't directly or indirectly injected into singletons.

The root service provider is created when [BuildServiceProvider](https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.servicecollectioncontainerbuilderextensions.buildserviceprovider) is called. The root service provider's lifetime corresponds to the app/server's lifetime when the provider starts with the app and is disposed when the app shuts down.

Scoped services are disposed by the container that created them. If a scoped service is created in the root container, the service's lifetime is effectively promoted to singleton because it's only disposed by the root container when app/server is shut down. Validating service scopes catches these situations when  `BuildServiceProvider`  is called.

To always validate scopes, including in the  `Production`  environment, configure the [ServiceProviderOptions](https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.serviceprovideroptions) with [UseDefaultServiceProvider](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.hosting.webhostbuilderextensions.usedefaultserviceprovider) on the host builder:

```csharp
WebHost.CreateDefaultBuilder(args)
    .UseDefaultServiceProvider((context, options) => {
        options.ValidateScopes = true;
    })
```