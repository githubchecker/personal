# DDL in SP

Yes, you can execute **DDL (Data Definition Language)** statements inside a Stored Procedure, but there are strict rules depending on **how** you execute them.

Here is the **Beginner to Expert** breakdown.

---

# üü¢ Phase 1: Direct Execution (Supported DDL)

Most standard DDL commands affecting **tables and indexes** can be written directly inside the SP logic.

### Supported Direct Commands

- `CREATE TABLE` (Temp or Permanent)
- `DROP TABLE`
- `TRUNCATE TABLE`
- `CREATE INDEX` / `ALTER INDEX`

**Example:**

```sql
CREATE PROCEDURE dbo.SetupDailyTables
AS
BEGIN
    -- 1. Create a permanent table directly
    IF OBJECT_ID('dbo.DailyLog') IS NULL
    BEGIN
        CREATE TABLE dbo.DailyLog (LogID INT, Msg VARCHAR(100));
    END

    -- 2. DDL: Create Index directly
    CREATE CLUSTERED INDEX IX_DailyLog ON dbo.DailyLog(LogID);

    -- 3. DDL: Truncate (Wipe)
    TRUNCATE TABLE dbo.StagingTable;
END

```

---

# üü† Phase 2: Indirect Execution (The Dynamic SQL Rule)

Certain DDL statements **cannot** be written directly in an SP because they require their own "Query Batch." You must wrap these in **Dynamic SQL**.

### The Blocked List (Must use `sp_executesql`)

- `CREATE VIEW`
- `CREATE TRIGGER`
- `CREATE FUNCTION`
- `CREATE PROCEDURE`
- `CREATE SCHEMA`

**‚ùå Fails (Syntax Error):**

```sql
CREATE PROCEDURE dbo.CreateViewWrapper
AS
BEGIN
    -- SQL Server complains: "CREATE VIEW must be the first statement in a query batch."
    CREATE VIEW dbo.MyView AS SELECT * FROM Users;
END

```

**‚úÖ Works (Dynamic SQL):**

```sql
CREATE PROCEDURE dbo.CreateViewWrapper
AS
BEGIN
    DECLARE @SQL NVARCHAR(MAX) = 'CREATE VIEW dbo.MyView AS SELECT * FROM Users';

    -- Execute in a separate dynamic scope
    EXEC sp_executesql @SQL;
END

```

---

# üîê Phase 3: Permissions (The Trap)

This is where most implementations fail in Production.

- **Scenario:** You grant `EXEC` permission on `dbo.MyProc` to a standard user (e.g., 'WebUser').
- **The Code:** Inside the proc, you run `TRUNCATE TABLE` or `CREATE TABLE`.
- **The Crash:** The SP crashes with **"User does not have permission to ALTER/CREATE."**

**Reason:** By default, the SP runs under the caller's identity. `EXEC` permission on the SP does **not** grant permissions to run DDL commands inside it.

**Solution: `WITH EXECUTE AS OWNER`**
You must escalate privileges specifically for that SP.

```sql
CREATE PROCEDURE dbo.AdminTask_ResetTable
WITH EXECUTE AS OWNER -- üõ°Ô∏è Impersonates the SP Creator (Admin)
AS
BEGIN
    -- Now 'WebUser' can run this, and it works because
    -- it runs as 'Admin' inside.
    TRUNCATE TABLE dbo.RestrictedData;

    ALTER TABLE dbo.RestrictedData ADD ProcessedDate DATETIME;
END

```

---

# üîÑ Phase 4: Transactions & Rollbacks (DDL is ACID)

In SQL Server, **DDL is Transactional**. This is different from Oracle (where DDL auto-commits).

If you Create or Alter a table inside a transaction and then `ROLLBACK`, the Table or Column disappears as if it never happened.

**Proof of Concept:**

```sql
CREATE PROC dbo.TestDDLTransaction
AS
BEGIN
    BEGIN TRANSACTION;

        -- 1. Create a Table
        CREATE TABLE dbo.GhostTable (Id INT);

        -- 2. Alter it
        ALTER TABLE dbo.GhostTable ADD Name VARCHAR(10);

    -- 3. Oops, an error! Undo everything.
    ROLLBACK TRANSACTION;

    -- RESULT: dbo.GhostTable does NOT exist in the database.
END

```

---

# ‚ö†Ô∏è Phase 5: The Performance Hit (Schema Stability)

Running DDL inside an SP causes **Recompilation**.

1. **SP Starts:** SQL creates an execution plan.
2. **DDL Hits:** You run `ALTER TABLE #MyTemp ADD Col2 INT`.
3. **Pause:** SQL Server realizes the Schema changed. The cached plan is invalid.
4. **Recompile:** SQL compiles a new plan for the rest of the procedure.

**Expert Advice:**

- Avoid `ALTER TABLE` in the middle of an SP. Define the table correctly with all columns in the initial `CREATE` statement.
- Avoid `CREATE INDEX` in the middle of a transaction if the table is huge; it locks resources heavily.

---

# üèÜ Summary

| DDL Type | Valid inside SP? | Requirement |
| --- | --- | --- |
| **CREATE / DROP / TRUNCATE Table** | ‚úÖ Yes | Direct Syntax allowed. |
| **CREATE / ALTER Index** | ‚úÖ Yes | Direct Syntax allowed. |
| **CREATE View / Func / Proc / Trigger** | ‚ùå No | Must use **Dynamic SQL** (`EXEC sp_executesql`). |
| **Security / Permissions** | ‚ö†Ô∏è Caution | User needs explicit DDL rights or use `WITH EXECUTE AS OWNER`. |
| **Transactions** | ‚úÖ Yes | DDL will Rollback if the transaction fails. |