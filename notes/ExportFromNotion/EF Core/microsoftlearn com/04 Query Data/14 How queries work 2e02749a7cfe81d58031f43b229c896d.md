# 14. How queries work

# How Queries Work

EF Core translates Language Integrated Query (LINQ) expressions into database-specific commands (like SQL). Understanding the internal pipeline helps in writing optimized queries and troubleshooting performance issues.

## 1. The Lifecycle of a Query

Every LINQ query goes through a multi-step process before data reaches your application.

- **Expression Building:** You define a LINQ query in C#. At this stage, it is just an "Expression Tree" (a data structure representing your logic).
- **Compilation & Caching:** EF Core analyzes the expression tree and compiles it into a query plan. To save time, this plan is cached and reused if the same query structure is used again.
- **Translation:** The database provider (e.g., SQL Server, SQLite) converts the plan into a database-specific language (SQL).
- **Execution:** The generated SQL is sent to the database. The database returns a raw result set (rows and columns).
- **Materialization:** EF Core transforms the raw result set back into .NET objects (entities).
- **No-Tracking Queries:** New instances are created for every row.

## 2. Deferred Execution

Queries are **not** executed when they are defined. They are only sent to the database when the results are actually "consumed."

### Common Triggering Operations:

- **Iteration:** Using a `foreach` loop or `await foreach`.
- **Collection Conversion:** Calling `.ToList()`, `.ToArray()`, or `.ToDictionary()`.
- **Single Element Operators:** Calling `.First()`, `.Single()`, `.Last()`, or `.Max()`.
- **Aggregates:** Calling `.Count()`, `.Sum()`, or `.Any()`.

```csharp
// Query is DEFINED here (No SQL sent yet)
var query = context.Blogs.Where(b => b.Rating > 4);

// Query is EXECUTED here
var list = await query.ToListAsync(); 

```

## 3. Security and Parameterization

EF Core automatically parameterizes yours queries. When you use variables in a LINQ query, they are sent to the database as parameters, which protects your application from **SQL Injection**.

```csharp
var name = "Arpan";
// SAFE: 'name' is handled as a @parameter
var blog = context.Blogs.Where(b => b.Name == name).First();

```

<aside>
⚠️ While EF Core prevents SQL injection, it does **not** validate your data logic. You must still validate that user-provided values are within acceptable bounds (e.g., checking that a "Price" variable is not a negative number).

</aside>

## 4. Summary Table

| Stage | Responsibility | Result |
| --- | --- | --- |
| **Translation** | Database Provider | Raw SQL string. |
| **Execution** | Database Server | Row/Column results. |
| **Materialization** | EF Core | C# Entity Objects. |
| **Caching** | EF Core | Reusable Query Plans. |